<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test demo</title>
    <style>
        * {
            margin: 0;
            padding: 1rem;
        }
        body {
            background-color: whitesmoke;
        }
        .plain {
            background-color: whitesmoke;
            font-weight: bold;
        }
        .log {
            background-color: lightgray;
        }
        .success {
            background-color: limegreen;
        }
        .fail {
            background-color: tomato;
        }
    </style>
</head>
<body>
<ul id="board">
    <script>
        const URI = "ws://localhost:8080/";
        const socket = new WebSocket(URI);
        let board = document.getElementById("board");

        function appendMessage(message, statusClass) {
            const p = document.createElement("p");
            p.textContent = message;
            p.className = statusClass;
            board.appendChild(p);
        }

        // WS log
        appendMessage("Websocket test: " + URI, "log");

        socket.addEventListener('open', function () {
            appendMessage("WebSocket connection opened ", "success");

            // SIGNATURE VERIFIER : invalid EVENT kind 1 log
            const testEventData_kind1 = {
                "id": "id4",
                "pubkey": "pubkey3",
                "created_at": 333333,
                "kind": 1,
                "tags": [],
                "content": "not so cool content",
                "sig": "xyz"
            };
            appendMessage("signature verifier negative test: sending INVALID kind 1 EVENT: ", "plain");
            appendMessage(JSON.stringify(["EVENT", testEventData_kind1]), "log");

            socket.addEventListener('message', function onKind1Response(message) {
                appendMessage("response to event kind1 received", "success");
                if (message.data === '["OK","id4",false,"invalid crypto data"]') {
                    appendMessage(message.data, "success");
                    appendMessage("OK - event declined", "success");
                } else {
                    appendMessage(message.data, "fail");
                    appendMessage("response to invalid sig kind 1 event FAIL", "fail");
                }
                socket.removeEventListener('message', onKind1Response);
                initiateKind1Event();
            });

            socket.send(JSON.stringify(["EVENT", testEventData_kind1]));
        });

        function initiateKind1Event() {
            const testEventData_kind1 = {
                "id": "512840ec2698eef9bfb62de589baae54005c7a5a1d7c1e106d986cc08a07696b",
                "pubkey" : "9197fca00c8173db07bdd5a96b10d3b8d401a747cf26505066b7d5b73538c7a1",
                "created_at": 1705574338,
                "kind": 1,
                "tags": [],
                "content": "cool content",
                "sig": "5a5c9919677045f364e5df4b6594dfbb57a62f52e8dd6e98d2ad5bb28a57710da1c7899e12a3156174ab4d2200421112c5b19841033430f06be62a9f524fa430"
            }
            appendMessage("signature verifier positive test sending valid kind 1 EVENT: ", "plain");
            appendMessage(JSON.stringify(["EVENT", testEventData_kind1]), "log");

            socket.addEventListener('message', function onKind1Event1Response(message) {
                appendMessage("response to event kind1 received", "success");
                if (message.data === '["OK","512840ec2698eef9bfb62de589baae54005c7a5a1d7c1e106d986cc08a07696b",true,""]') {
                    appendMessage(message.data, "success");
                    appendMessage("OK - event accepted", "success");
                } else {
                    appendMessage(message.data, "fail");
                    appendMessage("response to valid kind 1 event FAIL", "fail");
                }
                socket.removeEventListener('message', onKind1Event1Response);
                initiateKind0Event1();
            });

            socket.send(JSON.stringify(["EVENT", testEventData_kind1]));
        }

        function initiateKind0Event1() {
            appendMessage("sending kind 0 EVENT: ", "plain");
            appendMessage(JSON.stringify(["EVENT",{"content":"{\"name\":\"admin\",\"about\":\"personal info\",\"picture\":\"stringurl\"}","created_at":1705590491,"kind":0,"tags":[],"pubkey":"a23cceb5d5596f80c3249f15ebcf3e42c6aba0b3c88aaf572c018bb6c7e6180c","id":"3beb2f883fb05942dd6b2bcea55d11124724aba191a2274e4e4cb24a1318aa8f","sig":"9e409ae4b14c96eaea7d0ebb713003439600953696d715564f9b948f64839900f540390dadd2dd881d75e6b93bd63cd1c88d523e3d234d3fb573b627a5137731"}]), "log");

            socket.addEventListener('message', function onKind0Event1Response(message) {
                appendMessage("response to event kind 0_1 received", "success");
                if (JSON.parse(message.data)[0] === "OK" && JSON.parse(message.data)[1] === "3beb2f883fb05942dd6b2bcea55d11124724aba191a2274e4e4cb24a1318aa8f" && JSON.parse(message.data)[2] === true) {
                appendMessage(message.data, "success");
                appendMessage("OK - event kind 0_1 accepted", "success");
            } else {
                appendMessage(message.data, "fail");
                appendMessage("FAIL - event kind 0_1 declined", "fail");
            }
                socket.removeEventListener('message', onKind0Event1Response);
                initiateKind0Event2();
            });

            socket.send(JSON.stringify(["EVENT",{"content":"{\"name\":\"admin\",\"about\":\"personal info\",\"picture\":\"stringurl\"}","created_at":1705590491,"kind":0,"tags":[],"pubkey":"a23cceb5d5596f80c3249f15ebcf3e42c6aba0b3c88aaf572c018bb6c7e6180c","id":"3beb2f883fb05942dd6b2bcea55d11124724aba191a2274e4e4cb24a1318aa8f","sig":"9e409ae4b14c96eaea7d0ebb713003439600953696d715564f9b948f64839900f540390dadd2dd881d75e6b93bd63cd1c88d523e3d234d3fb573b627a5137731"}]));
        }

        function initiateKind0Event2() {
            // EVENT kind 0 log 2 (redundant data)
            appendMessage("sending second kind 0 EVENT: ", "plain");
            appendMessage(JSON.stringify(["EVENT",{"content":"{\"name\":\"admin\",\"about\":\"updated personal info\",\"picture\":\"stringurl\"}","created_at":1705590741,"kind":0,"tags":[],"pubkey":"a23cceb5d5596f80c3249f15ebcf3e42c6aba0b3c88aaf572c018bb6c7e6180c","id":"3cb094d2613d5481378e3a5a9e04cec6d8114df449a25c0bc99010a133a71b59","sig":"c6faae2a2e09c2a0d68ee1912118e2862def1bc891b96b800cca8595b989c898735dec55898b73bb0776e179aed26298bbf591db3db4554dc0dd4ccd094f72ed"}]), "log");

            socket.addEventListener('message', function onKind0Event2Response(message) {
                appendMessage("response to event kind 0_2 received", "success");
                if (message.data === '["OK","3cb094d2613d5481378e3a5a9e04cec6d8114df449a25c0bc99010a133a71b59",true,"metadata updated"]') {
                    appendMessage(message.data, "success");
                    appendMessage("OK - event kind 0_2 accepted", "success");
                } else {
                    appendMessage(message.data, "fail");
                    appendMessage("FAIL - event 0_2 declined", "fail");
                }
                socket.removeEventListener('message', onKind0Event2Response);
                initiateReq();
            });
            socket.send(JSON.stringify(["EVENT",{"content":"{\"name\":\"admin\",\"about\":\"updated personal info\",\"picture\":\"stringurl\"}","created_at":1705590741,"kind":0,"tags":[],"pubkey":"a23cceb5d5596f80c3249f15ebcf3e42c6aba0b3c88aaf572c018bb6c7e6180c","id":"3cb094d2613d5481378e3a5a9e04cec6d8114df449a25c0bc99010a133a71b59","sig":"c6faae2a2e09c2a0d68ee1912118e2862def1bc891b96b800cca8595b989c898735dec55898b73bb0776e179aed26298bbf591db3db4554dc0dd4ccd094f72ed"}]));
        }

            // REQ log 1
        function initiateReq() {
            const reqData = {
                "authors": ["pubkey4"],
                "since": 0
            }
            appendMessage("sending req(pubkey4) message: ", "plain");
            appendMessage(JSON.stringify(["REQ", "subId1", reqData]), "log");

            socket.addEventListener('message', function onReqPubKey1(message) {
                appendMessage("response req(pubkey4) received", "success");
                if (message.data === '["EOSE","subId1"]') {
                    appendMessage(message.data, "success");
                    appendMessage("OK - blank feed + eose", "success");
                } else {
                    appendMessage(message.data, "fail");
                    appendMessage("FAIL - no eose message", "fail");
                }
                socket.removeEventListener('message', onReqPubKey1);
                initiateReq2();
            });

            socket.send(JSON.stringify(["REQ", "subId1", reqData]));
        }

        function initiateReq2() {
            const reqData2 = {
                "authors": ["pubkey2"]
            }
            appendMessage("sending req(pubkey2) message: ", "plain");
            appendMessage(JSON.stringify(["REQ", "subId2", reqData2]), "log");

            socket.addEventListener('message', function onReqPubKey2(message) {
                appendMessage("response req(pubkey2) received", "success");
                if (message.data === JSON.stringify(["EVENT","subId2",{"id":"id3","pubkey":"pubkey2","created_at":222222,"kind":1,"tags":[],"content":"content3","sig":"sig3"}])) {
                    appendMessage(message.data, "success");
                    appendMessage("OK - event id3 - pubkey2", "success");
                } else {
                    appendMessage(message.data, "fail");
                    appendMessage("FAIL - failed to filter properly", "fail");
                }
                socket.removeEventListener('message', onReqPubKey2);
                initiateReq2_b();
            });

            socket.send(JSON.stringify(["REQ", "subId2", reqData2]));
        }

        function initiateReq2_b() {
            socket.addEventListener('message', function onReqPubKey3(message) {
                appendMessage("message2 - eose received", "success");
                if (message.data === JSON.stringify(["EOSE","subId2"])) {
                    appendMessage(message.data, "success");
                    appendMessage("OK - eose response" , "success");
                } else {
                    appendMessage(message.data, "fail");
                    appendMessage("FAIL - failed to eose", "fail");
                }
                socket.removeEventListener('message', onReqPubKey3);
                initiateReq3();
            });
        }

        function initiateReq3() {
            const reqData3 = {
                "kinds": [0]
            }
            appendMessage("sending req(kind0) message: ", "plain");
            appendMessage(JSON.stringify(["REQ", "subId3", reqData3]), "log");

            socket.addEventListener('message', function onReqPubKey3(message) {
                appendMessage("response req(kind0) received", "success");
                if (message.data === JSON.stringify(["EVENT","subId3",{"id":"3cb094d2613d5481378e3a5a9e04cec6d8114df449a25c0bc99010a133a71b59","pubkey":"a23cceb5d5596f80c3249f15ebcf3e42c6aba0b3c88aaf572c018bb6c7e6180c","created_at":1705590741,"kind":0,"tags":[],"content":"{\"name\":\"admin\",\"about\":\"updated personal info\",\"picture\":\"stringurl\"}","sig":"c6faae2a2e09c2a0d68ee1912118e2862def1bc891b96b800cca8595b989c898735dec55898b73bb0776e179aed26298bbf591db3db4554dc0dd4ccd094f72ed"}])) {
                    appendMessage(message.data, "success");
                    appendMessage("OK - got own event 0", "success");
                } else {
                    appendMessage(message.data, "fail");
                    appendMessage("FAIL - failed to filter properly", "fail");
                }
                socket.removeEventListener('message', onReqPubKey3);
                initiateReq3_b();
            });

            socket.send(JSON.stringify(["REQ", "subId3", reqData3]));
        }

        function initiateReq3_b() {
            socket.addEventListener('message', function onReqPubKey3_b(message) {
                appendMessage("message2 - eose received:", "success");
                if (message.data === JSON.stringify(["EOSE","subId3"])) {
                    appendMessage(message.data, "success");
                    appendMessage("OK - eose response" , "success");
                } else {
                    appendMessage(message.data, "fail");
                    appendMessage("FAIL - failed to eose", "fail");
                }
                socket.removeEventListener('message', onReqPubKey3_b);
                initiateKind0Event3();

            });
        }

        function initiateKind0Event3() {
            appendMessage("sending kind 0 EVENT: ", "plain");
            appendMessage(JSON.stringify(["EVENT", {
                "content": "{\"name\":\"PavelSlimBilek\",\"about\":\"about me\",\"picture\":\"myupdatedpicture\"}",
                "created_at": 1705612806,
                "kind": 0,
                "tags": [],
                "pubkey": "a23cceb5d5596f80c3249f15ebcf3e42c6aba0b3c88aaf572c018bb6c7e6180c",
                "id": "dda5d1052eef2b2ba4d9580545097d7aa19d8d0bd5fa7a79ace0b80b2c72d7e0",
                "sig": "5daf34402b4b1caf79dbf9e84a53b833a72ca6501eb81107e4ee51f4bed8fc6ad9841202c70d809d0ea204f0218660d5a5a1753b8a5eff5174e85735df0ff95b"
            }]), "log");

            socket.addEventListener('message', function onKind0Event3Response(message) {
                appendMessage("response to event kind 0_1 received", "success");
                if (JSON.parse(message.data)[0] === "OK" && JSON.parse(message.data)[1] === "dda5d1052eef2b2ba4d9580545097d7aa19d8d0bd5fa7a79ace0b80b2c72d7e0" && JSON.parse(message.data)[2] === true) {
                    appendMessage(message.data, "success");
                    appendMessage("OK - event kind 0_3 accepted", "success");
                } else {
                    appendMessage(message.data, "fail");
                    appendMessage("FAIL - event kind 0_1 declined", "fail");
                }
                socket.removeEventListener('message', onKind0Event3Response);
                initiateKind0Event3b();
            });

            socket.send(JSON.stringify(["EVENT", {
                "content": "{\"name\":\"PavelSlimBilek\",\"about\":\"about me\",\"picture\":\"myupdatedpicture\"}",
                "created_at": 1705612806,
                "kind": 0,
                "tags": [],
                "pubkey": "a23cceb5d5596f80c3249f15ebcf3e42c6aba0b3c88aaf572c018bb6c7e6180c",
                "id": "dda5d1052eef2b2ba4d9580545097d7aa19d8d0bd5fa7a79ace0b80b2c72d7e0",
                "sig": "5daf34402b4b1caf79dbf9e84a53b833a72ca6501eb81107e4ee51f4bed8fc6ad9841202c70d809d0ea204f0218660d5a5a1753b8a5eff5174e85735df0ff95b"
            }]));
        }

        function initiateKind0Event3b() {
            socket.addEventListener('message', function onEventKind0_3b(message) {
                if (message.data === JSON.stringify(["EVENT","subId3",{"id":"dda5d1052eef2b2ba4d9580545097d7aa19d8d0bd5fa7a79ace0b80b2c72d7e0","pubkey":"a23cceb5d5596f80c3249f15ebcf3e42c6aba0b3c88aaf572c018bb6c7e6180c","created_at":1705612806,"kind":0,"tags":[],"content":"{\"name\":\"PavelSlimBilek\",\"about\":\"about me\",\"picture\":\"myupdatedpicture\"}","sig":"5daf34402b4b1caf79dbf9e84a53b833a72ca6501eb81107e4ee51f4bed8fc6ad9841202c70d809d0ea204f0218660d5a5a1753b8a5eff5174e85735df0ff95b"}])) {                    appendMessage(message.data, "success");
                    appendMessage(message.data, "success");
                    appendMessage("OK - event response" , "success");
                } else {
                    appendMessage(message.data, "fail");
                    appendMessage("FAIL", "fail");
                }
                socket.removeEventListener('message', onEventKind0_3b);
                initiateClose();
            });
        }

        function initiateClose() {
            appendMessage("sending close(subId3) message: ", "plain");
            appendMessage(JSON.stringify(["CLOSE", "subId3"]), "log");

            socket.addEventListener('message', function onClose(message) {
                appendMessage("response req(kind0) received", "success");
                if (message.data === JSON.stringify(["NOTICE","subscription closed"])) {
                    appendMessage(message.data, "success");
                    appendMessage("OK - subscription closed", "success");
                } else {
                    appendMessage(message.data, "fail");
                    appendMessage("FAIL", "fail");
                }
                socket.removeEventListener('message', onClose);
            });

            socket.send(JSON.stringify(["CLOSE", "subId3"]));
        }
    </script>
</ul>
</body>
</html>
